<div class="layui-fluid">
  <div class="layui-row layui-col-space15">
    <div class="layui-col-md12">
      <div class="layui-row layui-col-space15">
 
        <div class="layui-col-md12">
          <div class="layui-card">
            <div class="layui-card-header">一月流量趋势</div>
            <div class="layui-card-body">
              
              <div class="layui-carousel layadmin-carousel layadmin-dataview" data-anim="fade" lay-filter="LAY-index-dataview">
                <div carousel-item id="LAY-index-dataview">
                  <!--<div><i class="layui-icon layui-icon-loading1 layadmin-loading"></i></div>
                  <div></div>-->
                  <div></div>
                </div>
              </div>
              
            </div>
          </div>
        
          
     <div class="layui-card">
     	<div class="layui-card-header" id="flow_header">当日流量排行前1000名</div>
      <div class="layui-form layui-card-header layuiadmin-card-header-auto layui-hide" lay-filter="app-content-list">
        <div class="layui-form-item">
          <div class="layui-inline">
            <label class="layui-form-label">日期</label>
            <div class="layui-input-inline">
              <input type="text" name="date" id="date" placeholder="可不选" class="layui-input">
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">IP</label>
            <div class="layui-input-inline">
              <input type="text" name="ip" id="ip" placeholder="可不填" autocomplete="off" class="layui-input">
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">内容</label>
            <div class="layui-input-inline">
              <input type="text" name="content" id="content" placeholder="可不填" autocomplete="off" class="layui-input">
            </div>
          </div>
         
          <div class="layui-inline">
            <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-app-contlist-search">
              <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="layui-card-body">    
        <table id="LAY-app-content-list" lay-filter="LAY-app-content-list"></table>         
      </div>
    </div>
    
          
        </div>
      </div>
    </div>
    
    
  
     
    
   
  </div>
</div>

<script type="text/html" id="flowSend">	
    <div> 
        {{# if (parseInt(d.tx_bytes) > 1024*1024*1024) { }}
           <span class="layui-badge layui-bg-orange">{{parseFloat(parseInt(d.tx_bytes)/1073741824).toFixed(3)}} GB</span>
        {{# } else if (parseInt(d.tx_bytes) > 1024*1024) { }}  
         	 <span class="layui-badge layui-bg-green">{{parseFloat(parseInt(d.tx_bytes)/1048576).toFixed(0)}} MB</span>
        {{# } else { }}
        	<span class="layui-badge layui-bg-green">{{d.tx_bytes}} </span>
        {{# } }}		
    </div>
</script>

<script type="text/html" id="flowTpl">	
    <div> 
        {{# if (parseInt(d.rx_bytes) > 1024*1024*1024) { }}
           <span class="layui-badge layui-bg-orange">{{parseFloat(parseInt(d.rx_bytes)/1073741824).toFixed(3)}} GB</span>
        {{# } else if (parseInt(d.rx_bytes) > 1024*1024) { }}  
         	 <span class="layui-badge layui-bg-green">{{parseFloat(parseInt(d.rx_bytes)/1048576).toFixed(0)}} MB</span>
        {{# } else { }}
        	<span class="layui-badge layui-bg-green">{{d.rx_bytes}} </span>
        {{# } }}		
    </div>
</script>

<script type="text/html" id="atknum">
     <div>
      {{# if (d.rx_pkts == "0") { }}
        <span class="layui-badge layui-bg-green">{{d.rx_pkts}} </span>
      {{# } else { }}
      	<span class="layui-badge febs-bg-flowcolor1">{{d.rx_pkts}} </span>
      {{# } }}	
    </div>
</script>

<script src="util.js"> </script>

<script type="text/javascript">
	var layer = layui.layer;
	var $ = jQuery = layui.jquery;
	var  element = layui.element;
  var form = layui.form;
  var topx =[];
  var topy = [];
  var x2data = [];
  var y2data = [];  
  
  var token = CoreUtil.getStok("token");
	if (token == undefined || token == null || token.length < 32 )
	    token = "12345";
    
  var id =  getid(); 
  var tablename = "/bigdata/flux30.json?token="+ token;	  
  var filtername = "/bigdata/table0.json?token="+ token;	 	
   
  function getid() { 
  	 
  	 var   str = "abcdefgh" + window.location;
     var   i = str.indexOf("table");
     
     if   (i < 0)
           return "0";
                                 
     var   out = str.substr(i + 5,1);
           return out;
  }
 
  	    
  function GetQueryString(name) { 
     var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)","i"); 
     var r = window.location.search.substr(1).match(reg); 
     if (r!=null) return (r[2]); return null; 
  } 
    
  form.render(null, 'app-content-list');
  //搜索
  form.on('submit(LAY-app-contlist-search)', function(data){
      var field = data.field;
      
      //执行重载
      table.reload('LAY-app-content-list', {
        where: field
      });      
      
      if ($("#date").val() != "") {      
          window.location.reload();
      }
    });
	

	function abc() {
	    CoreUtil.sendAjax("/bigdata/flowdate.json?token="+ token,null,function (res) {	
	    
	          if (res.date != null)
	              $('#flow_header').html(res.date+"日排名前1000的流量列表"); 
	               
            if (res.data != null){  
            	  //loadTop();
            	  
                loadTable("/bigdata/ipstats.json?token="+ token,"#LAY-app-content-list",res.data,res.title);  
                  
                /*table.reload('LAY-home-homepage-console', {
                    elem: '#LAY-home-homepage-console'
                    ,data: res.top10
                });
                 
                topx = res.topx;
                topy = res.topy; */
            } 
            
      },"GET",false);
	}
	

	abc();
	//setInterval(abc,300000);


  layui.use('flux', layui.factory('flux'));
  
 function calc_time(v){
    	  var  sec = parseInt(v) % 60;
    	   
        if(parseInt(v) > 60*60){
        	 sec = (parseInt(v) % 3600) / 60; 
            v = v * 1.0 / (60*60) - 0.5;                     
            return v.toFixed(0) + "时" + sec.toFixed(0)+ "分";
        }
        if(parseInt(v) > 60){
            v = v * 1.0 / (60);
            return v.toFixed(0) + "分" + sec + "秒";
        }
        return v + "秒";
    }   
    
	var table = (layui.$, layui.table);
	//渲染table
  var loadTable = function (myurl,myelem,data,title) {    
      var content="content1";
      var j = 0;
      var cols_arr=new Array();
      
      cols_arr[0] = [];
      cols_arr[0][0] = {type: "numbers",fixed: "left"};     		
      cols_arr[0][1] = {field: "addr",title: "IP地址",minWidth: 50,	sort: !0,
      	  templet: '<div><a href="/webpages/index.html?trace-log&sip={{ d.addr }}" target="_blank" class="layui-table-link">{{ d.addr }}</div>'    	 
      	};
      cols_arr[0][2] = {field: "geoip",title: "地理位置",minWidth: 50};  
      cols_arr[0][3] = {field: "stime",title: "开始时间",sort: !0,	minWidth: 50	};	
      cols_arr[0][4] = {field: "etime",title: "结束时间",sort: !0,	minWidth: 50	};
      cols_arr[0][5] = {field: "time",title: "在线时长",sort: !0,	minWidth: 50, templet: function (item) {
                                return calc_time(item.time);
                        }}; 
      
      
      cols_arr[0][6] = {field: "tx_bytes",title: "发送流量",sort: !0,	minWidth: 50,templet:'#flowSend'	}; 
      cols_arr[0][7] = {field: "rx_bytes",title: "接收流量",sort: !0,	minWidth: 50,templet:'#flowTpl'}; 
      cols_arr[0][8] = {field: "tx_pkts",title: "请求数量",sort: !0,	minWidth: 50	}; 
      cols_arr[0][9] = {field: "rx_pkts",title: "攻击数量",sort: !0,	minWidth: 50,templet:'#atknum'}; 

      
      table.render({
                elem: myelem
                ,url: myurl 
                ,initSort: {
                    field: 'rx_bytes' 
                    ,type: 'desc' //排序方式  asc: 升序、desc: 降序、null: 默认排序
                 }            
                ,page: 0
                ,cellMinWidth: 120
                , cols: cols_arr
                ,skin: "line"               
            });
            
      //cols_arr.length = 0;
  };

  
   var loadTop = function () {  
      
      table.render({
                elem: "#LAY-home-homepage-console",             
	              data:[],
		            cols: [[
								{
									type: "numbers",
									fixed: "left",
									width: 50
								},
								{
									field: "src_ip",
									title: "IP地址",
									width: 150
								},
								{
									field: "geoip",
									title: "地理位置",			
								},
								{
									field: "count",
									title: "访问次数",			
								}/*,
								{
									field: "risk",
									title: "风险等级",
									width: 60,
									templet: function(e) {
										return "中" == e.risk ? '<del style="color: #5FB878;">' + e.risk + "</del>": "高" == e.risk ? '<span style="color: #FFB800;">' + 
										       e.risk + "</span>": '<span style="color: #FF5722;">' + e.risk + "</span>"
									}
								}*/]],
								skin: "line"          
    });
            
   
  };
     
        


</script>

